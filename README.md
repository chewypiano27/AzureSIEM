# AzureSIEM
Real-Time Threat Detection & Analysis using a Honeypot and Security Information and Events Management (SIEM) Platform; Azure & Sentinel

<p align="center">
  <img src="https://github.com/user-attachments/assets/eaad7f8f-a490-4255-b0c6-b193b66e0934" width="800">
  <img src="https://github.com/user-attachments/assets/9e06de68-d942-4c0b-8048-f0cb364ea90b" width="800">
</p>

## Executive Summary
This project designed and implemented a home Security Operations Center (SOC) in Microsoft Azure to detect and analyze real-world brute-force attacks. A honeypot VM, intentionally exposed to the public internet, attracted almost 34,000 brute-force attempts over a 163-hour testing period. Log analysis and visualization within Microsoft Sentinel, using Kusto Query Language (KQL), provided real-time insights into attack sources and patterns. The project demonstrated practical skills in log analysis, threat detection, and SOC operations in a cloud environment, aligning with industry best practices such as NIST 800-61 & NIST 800-53. Key findings revealed a significant reduction in attack traffic after implementing stricter Network Security Group (NSG) rules, highlighting the effectiveness of layered security. The project also explored automated incident response and future enhancements involving AI and internal honeypot traps to further strengthen threat detection capabilities. 

 
High-level overview: 

●	Setting up an insecure VM 

●	Configuring Log Analytics Workspace 

●	Forwarding logs and integrating with Sentinel 

●	Querying failed login attempts and visualising attack sources 

●	Visualising an attack heatmap to track real-time hacker activity 

 
__Key Skills: log analysis, threat detection, and SOC operations in a real-world cloud environment.__

**Key Components and Technologies:**

●	Honeypot (Azure VM) 
  
  A deliberately vulnerable virtual machine acts as a decoy to attract and trap attackers attempting brute-force logins. Its public IP address is exposed to the internet. 
  
●	Network Security Group (NSG) 
  
  While the honeypot is intentionally exposed, an NSG is still used for initial traffic filtering and can be configured to block known malicious IP addresses or restrict access to specific ports if needed. This provides a basic layer of defense while allowing the honeypot to fulfill its purpose. 
  
●	Log Analytics Workspace 
  
  Serves as a central repository for logs generated by the honeypot VM. The Azure Monitoring Agent installed on the VM forwards security logs, including failed login attempts (Event ID 4625), to the workspace.
  
●	Microsoft Sentinel (SIEM) 
  
  Integrates with the Log Analytics Workspace to provide advanced threat detection and analysis capabilities. KQL queries are used to filter, analyse, and visualise attack data. Sentinel's built-in dashboards and workbooks enable real-time monitoring and reporting. 

●	GeoIP Lookup (Sentinel Watchlist) 
  
  Enriches security logs with geolocation data, providing insights into the geographic origin of attacks. This data is crucial for identifying attack patterns and potential threat actors. 

●	Kusto Query Language (KQL) 
  
  The powerful query language used within Sentinel to extract, transform, and analyse log data. Custom KQL queries are developed to identify brute-force attempts, correlate events, and generate visualisations. 

●	Attack Heatmap (Sentinel Workbook) 
  
  A custom workbook within Sentinel displays a real-time heatmap of attack sources, providing a visual representation of global attack activity against the honeypot. 

## Threat Analysis & Research

### Problem Statement 
The increasing reliance on internet-facing systems across all industries expands the attack surface for malicious actors. Brute-force attacks, exploiting weak or default credentials, remain a prevalent threat, particularly targeting the Remote Desktop Protocol (RDP) commonly used for remote administration. The healthcare sector, with its growing dependence on interconnected systems and remote access for patient care, is a prime target. Ransomware, often delivered through brute-force attacks, poses a critical threat, potentially disrupting operations, compromising patient data, and leading to significant financial and reputational damage. This vulnerability is classified as T1110 - Brute Force within the MITRE ATT&CK framework. 

### Threat Impact 
The SamSam ransomware campaign (2015-2018) serves as a stark example of the devastating impact of brute-force attacks combined with ransomware deployment. This Advanced Persistent Threat (APT), attributed to Iranian hackers, had targeted hospitals, municipalities, and businesses, successfully infiltrating networks through RDP brute-force attacks. The City of Atlanta (in 2018), Hancock Health Hospital, and the Colorado Department of Transportation, among others, fell victim to SamSam, experiencing significant disruptions to critical services. As a consequence, this resulted in these organisations incurring substantial recovery costs. In the healthcare context, such attacks can jeopardise patient safety by delaying or denying access to essential medical records and systems. The financial ramifications include ransom payments, system restoration expenses, legal fees, and reputational damage. Beyond direct financial costs, these attacks erode public trust and can have long-lasting consequences for the affected organisations. 


### Current Security & Compliance Gaps 
Traditional security measures often fall short in effectively mitigating brute-force attacks. Basic password policies, while necessary, are often insufficient to deter determined attackers. Many organisations lack multi-factor authentication (MFA), leaving accounts vulnerable even with strong passwords. Network-level protections, such as firewalls, can be bypassed if RDP ports are exposed to the internet. Furthermore, many organisations lack real-time threat detection capabilities. Log analysis is often performed retroactively, leaving a window of opportunity for attackers to establish a foothold and deploy malware. The lack of automated incident response mechanisms further exacerbates the problem, delaying containment and remediation efforts. Compliance gaps, particularly in adhering to frameworks like NIST Cybersecurity Framework and HIPAA in the healthcare sector, contribute to vulnerabilities and increase the risk of successful attacks. 


## Security Solution Design 

### Proposed solution 
This project implements a multi-layered security solution centered around a honeypot deployed in Microsoft Azure, integrated with a Security Information and Event 
Management (SIEM) system for real-time threat detection and analysis. 

## Project Architecture

<p align="center">
  <img src="https://github.com/user-attachments/assets/eaad7f8f-a490-4255-b0c6-b193b66e0934">
</p>

### Workflow

●	Public Internet 

Represents the external network where potential attackers reside. These attackers attempt to access resources within the Azure environment. 

●	Network Security Group (NSG) 

Acts as a firewall to filter network traffic to and from Azure resources. It blocks unauthorised access attempts from the public internet, providing a layer of security. 

●	Azure Subscription 

The overarching container for all Azure resources, including the virtual network and other components. 

●	Resource Group 

A logical container within the Azure subscription that holds related resources for an Azure solution. 

●	Virtual Network (VNet) 

Provides an isolated network environment within Azure, allowing resources to securely communicate with each other. 

●	Virtual Machine (VM) 

Represents a compute resource within the VNet that can run applications and services. It is protected by the NSG. 

●	Log Analytics Workspace 

Collects and analyses data from various sources, including the VM, to provide insights into the environment's security posture. 

●	Microsoft Sentinel (SIEM) 

A cloud-native security information and event management (SIEM) system that aggregates data from the Log Analytics Workspace. It provides advanced threat detection and response capabilities. 

●	Security Operations Center (SOC) 

The centralised unit that monitors, detects, and responds to security incidents using the tools and data provided by Microsoft Sentinel and other Azure services. 
 
## Configuration

### 1. Honeypot Deployment: 

●	I created a Resource Group in Azure to organise project resources. 

●	Deployed a Windows Server VM within the Resource Group. (Specify VM size and OS version). Named the VM "BANKING-PC" to entice potential attackers. 

●	Configured the VM's networking to allow public IP connectivity. This exposes the honeypot to potential attacks. 

●	Disabled the Windows Firewall within the VM to maximise the attack surface and capture a wider range of attack attempts. 

### 2. Log Analytics Workspace Setup: 

●	I created a Log Analytics Workspace within the same Resource Group. 

●	Enabled the "Windows Security Events" data connector in the workspace to collect relevant security logs. 

### 3. Sentinel Integration: 

● I enabled Microsoft Sentinel and connected it to the Log Analytics Workspace. 

This allows Sentinel to access and analyse the collected logs. 

### 4. Data Collection Rule: 

●	I created a data collection rule to configure the VM to forward its security logs to the Log Analytics Workspace; ensuring continuous log streaming to Sentinel. 

●	Confirmed successful installation and operation of the Azure Monitoring Agent on the VM. 

### 5. KQL Querying and Validation: 

● Used KQL queries within Sentinel to validate log ingestion and analyse failed login attempts (Event ID 4625). 

Initial KQL Query: 

    SecurityEvent 
    | where EventID == 4625 

This outputs only the security events that were unsuccessful login attempts. 

### 6. GeoIP Enrichment: 

● Imported a GeoIP database (CSV format) into a Sentinel watchlist; enabling geolocation of attacker IP addresses. 

### 7. Advanced KQL Querying and Visualisation: 

● Developed a more advanced KQL query to enrich failed login events with geolocation 

Advanced KQL query: 

    let GeoIPDB_FULL = _GetWatchlist("geoip"); let WindowsEvents = SecurityEvent     
    | where EventID == 4625 
        | order by TimeGenerated desc 
        | evaluate ipv4_lookup(GeoIPDB_FULL, IpAddress, network); 
    WindowsEvents 
    | project TimeGenerated, Computer, AttackerIP = IpAddress, cityname, countryname, latitude, longitude 

The aforementioned KQL query retrieves failed login attempts (Event ID 4625) from the SecurityEvent table, sorts them by TimeGenerated, and enriches them with geolocation data from a watchlist named GeoIPDB_FULL. An IPv4 lookup is performed, to match each attacker's IP address with geographic details like city, country, latitude, and longitude. It outputs the most pertinent information; the timestamp, computer name, attacker’s IP, and geolocation information. 

### 8. Attack Heatmap Creation: 

● Created a custom Sentinel workbook and added the advanced KQL query to generate a real-time attack heatmap. 

KQL script in advanced editor 

    { 
    	 	"type": 3, 
    	 	"content": { 
    	 	"version": "KqlItem/1.0", 
    	 	"query": "let GeoIPDB_FULL = _GetWatchlist(\"geoip\");\nlet WindowsEvents = 
    SecurityEvent;\nWindowsEvents | where EventID == 4625\n| order by TimeGenerated desc\n| evaluate ipv4_lookup(GeoIPDB_FULL, IpAddress, network)\n| summarize FailureCount = count() by IpAddress, latitude, longitude, cityname, countryname\n| project FailureCount, AttackerIp = IpAddress, latitude, longitude, city = cityname, country = countryname,\nfriendly_location = strcat(cityname, \" (\", countryname, \")\");", 
    	 	"size": 3, 
    	 	"timeContext": { 
    	 	 	"durationMs": 2592000000 
    	 	}, 
    	 	"queryType": 0, 
    	 	"resourceType": "microsoft.operationalinsights/workspaces", 
    	 	"visualization": "map", 
    	 	"mapSettings": { 
    	 	 	"locInfo": "LatLong", 
    	 	 	"locInfoColumn": "countryname", 
    	 	 	"latitude": "latitude", 
    	 	 	"longitude": "longitude", 
    	 	 	"sizeSettings": "FailureCount", 
    	 	 	"sizeAggregation": "Sum", 
    	 	 	"opacity": 0.8, 
    	 	 	"labelSettings": "friendly_location", 
    	 	 	"legendMetric": "FailureCount", 
    	 	 	"legendAggregation": "Sum", 
    	 	 	"itemColorSettings": { 
    	 	 	"nodeColorField": "FailureCount", 
    	 	 	"colorAggregation": "Sum", 
     	 	"type": "heatmap",  	 	"heatmapPalette": "greenRed" 
    	 	 	} 
    	 	} 
    	 	}, 
    	 	"name": "query - 0" 
 
### 9. Automated Incident Response 

● I created a new Scheduled Query Rule in Sentinel named "Brute-Force Attempt Detection." 

    SecurityEvent 
    | where EventID == 4625  // Failed login attempts 
    | summarize FailedCount = count() by Account, bin(TimeGenerated, 5m) 
    | where FailedCount > 5 

This query identifies potential brute-force attacks by counting failed logins within 5-minute windows, triggering an alert when the count exceeds 5. The rule runs every 5 minutes for near real-time detection. Moreover, I configured the rule to automatically create incidents from these alerts with a "High" severity for prioritised investigation. 

### 10. Playbook Creation and Configuration 

I created a new Playbook in Sentinel’s Automation section using Azure Logic Apps. I then defined the following actions: 

- Get Incident Details: This action retrieves essential information about the triggered incident, including the attacker's source IP address. 

- Simulate IP Blocking: Due to the limitations of the free Azure trial, direct automated blocking was not possible. Therefore, I implemented a simulated blocking action. This action logs the IP address that would have been blocked in a production environment, demonstrating the intended workflow. In a real-world scenario, this step would integrate with Azure Firewall or Network Security Groups to dynamically block the malicious IP. 

- Notification: The Playbook sends an email notification to a designated security email address with the subject "Alert: Multiple Failed Logins Detected." The email body includes details about the triggered alert, such as the affected account, and the source IP address. 

- Incident Update: The Playbook updates the Sentinel incident with information about the automated response, including the simulated blocking action; creating a comprehensive audit trail of the actions taken. 

## Testing Methodology

The honeypot VM was left running and exposed to the internet for an extended period (approximately 163 hours) to collect a substantial dataset of real-world attack attempts. 

This passive approach allowed for the observation of organic attack patterns without simulating specific attacks. The increasing density of data points on the attack heatmap over time provided clear evidence of ongoing brute-force attempts against the honeypot. 
